<!doctype html>
<html lang="zh-HK">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ•¸å­¸é¸æ“‡é¡Œç·´ç¿’å™¨</title>
  <style>
    :root {
      --base-font-size: 16px;
    }

    /* Midnight Theme (Default) */
    body.theme-midnight {
      --bg-main: #0b1020;
      --bg-card: #121933;
      --bg-input: #0f172a;
      --text-primary: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #22c55e;
      --accent-text: #052e16;
      --border: #243050;
      --q-border: #334155;
      --ok-bg: #052e16;
      --ok-text: #86efac;
      --bad-bg: #3f1d1d;
      --bad-text: #fca5a5;
    }

    /* Solarized Light Theme */
    body.theme-solar {
      --bg-main: #fdf6e3;
      --bg-card: #eee8d5;
      --bg-input: #eee8d5;
      --text-primary: #586e75;
      --text-muted: #93a1a1;
      --accent: #b58900;
      --accent-text: #fdf6e3;
      --border: #dcd3b8;
      --q-border: #93a1a1;
      --ok-bg: #859900;
      --ok-text: #fdf6e3;
      --bad-bg: #dc322f;
      --bad-text: #fdf6e3;
    }

    /* Cyberpunk Theme */
    body.theme-cyber {
      --bg-main: #000000;
      --bg-card: #0d0d0d;
      --bg-input: #1a1a1a;
      --text-primary: #00ff41;
      --text-muted: #008f11;
      --accent: #ff00ff;
      --accent-text: #000000;
      --border: #00ff41;
      --q-border: #00ff41;
      --ok-bg: #00ff41;
      --ok-text: #000000;
      --bad-bg: #ff0000;
      --bad-text: #ffffff;
    }

    /* Sepia Theme */
    body.theme-sepia {
      --bg-main: #f4ecd8;
      --bg-card: #e8dab9;
      --bg-input: #e0cf9f;
      --text-primary: #5b4636;
      --text-muted: #8c7b6c;
      --accent: #d35400;
      --accent-text: #fef9ef;
      --border: #c9b38c;
      --q-border: #a68b6a;
      --ok-bg: #27ae60;
      --ok-text: #fef9ef;
      --bad-bg: #c0392b;
      --bad-text: #fef9ef;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      font-size: var(--base-font-size);
      transition: background 0.3s, color 0.3s;
    }

    .wrap {
      max-width: 980px;
      margin: 24px auto;
      padding: 16px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 14px;
    }

    h1 {
      margin: 0 0 8px;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    input:not([type="checkbox"]):not([type="radio"]),
    button,
    select {
      border-radius: 10px;
      border: 1px solid var(--q-border);
      background: var(--bg-input);
      color: var(--text-primary);
      padding: 10px;
      font-size: 1rem;
    }

    input[type="checkbox"],
    input[type="radio"] {
      width: 1.125rem;
      height: 1.125rem;
      cursor: pointer;
      accent-color: var(--accent);
    }

    button {
      cursor: pointer;
      border: none;
      background: var(--accent);
      color: var(--accent-text);
      font-weight: 700;
    }

    button.secondary {
      background: var(--text-muted);
      color: var(--bg-main);
    }

    .q {
      border: 1px solid var(--q-border);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
      background: var(--bg-input);
    }

    .q h3 {
      margin: 0 0 10px;
      font-size: 17px;
    }

    .opt {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin: 8px 0;
    }

    .opt input {
      width: auto;
      margin-top: 2px;
    }

    .opt .opt-text {
      display: block;
      white-space: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      font-size: 0.9375rem;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      align-items: center;
    }

    .controls .full {
      grid-column: 1 / -1;
    }

    .topic-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px;
      border: 1px solid var(--q-border);
      border-radius: 10px;
      background: var(--bg-input);
    }

    .topic-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      cursor: pointer;
    }

    .topic-item input {
      margin: 0;
    }

    .hidden-after-generate {
      display: block;
    }

    .show-after-generate {
      display: none;
    }

    .collapsed .hidden-after-generate {
      display: none !important;
    }

    .collapsed .show-after-generate {
      display: inline-block;
    }

    .theme-btn {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 100;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .font-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .font-sample {
      padding: 12px;
      border: 1px dashed var(--q-border);
      border-radius: 8px;
      background: var(--bg-main);
      text-align: center;
      font-size: var(--base-font-size);
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: var(--q-border);
      appearance: none;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
    }

    @media (max-width: 700px) {
      .controls {
        grid-template-columns: 1fr;
      }

      .controls .full {
        grid-column: 1 / -1;
      }

      .controls input:not([type="checkbox"]),
      .controls button {
        width: 100%;
        min-height: 44px;
      }

      button {
        padding: 10px 12px;
        font-size: 15px;
      }
    }

    .result {
      margin-top: 8px;
      padding: 8px;
      border-radius: 8px;
      font-size: 0.875rem;
      white-space: pre-wrap;
    }

    .ok {
      background: var(--ok-bg);
      color: var(--ok-text);
    }

    .bad {
      background: var(--bad-bg);
      color: var(--bad-text);
    }

    .hide {
      display: none;
    }

    .sticky {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .summary {
      font-weight: 700;
    }
  </style>
</head>

<body>
  <button id="theme-btn" class="theme-btn" title="åˆ‡æ›ä¸»é¡Œ">ğŸ¨</button>
  <main class="wrap">
    <section class="card sticky" id="controlCard">
      <h1>åŒé¡é¡Œç·´ç¿’ï¼ˆé¸æ“‡é¡Œï¼‰</h1>
      <p class="muted hidden-after-generate">æ”¯æ´å¤šé …é¡Œå‹é¸æ“‡ï¼Œå¯ç”Ÿæˆ 1-100 é¡Œã€å¤šé …é¸æ“‡ä½œç­”ã€äº¤å·æ‰¹æ”¹ï¼Œç­”éŒ¯æœƒé¡¯ç¤ºè¨ˆç®—æ–¹æ³•ã€‚</p>
      <div class="controls">
        <div id="topicGroup" class="topic-group full hidden-after-generate">
          <label class="topic-item"><input type="checkbox" name="topic" value="factor" checked> å¹³æ–¹å·®å› å¼åˆ†è§£ï¼šaÂ² -
            (bm+cn)Â²</label>
          <label class="topic-item"><input type="checkbox" name="topic" value="quadratic-k" checked> äºŒæ¬¡æ–¹ç¨‹èˆ‡åƒæ•¸ï¼š (x-pk)Â² =
            qkÂ²</label>
          <label class="topic-item"><input type="checkbox" name="topic" value="power-scale" checked>
            æŒ‡æ•¸é¡Œï¼šæ¬¡æ–¹ç­‰æ¯”ä¾‹ç¸®æ”¾æ³•</label>
          <label class="topic-item"><input type="checkbox" name="topic" value="least-compare" checked>
            æŒ‡æ•¸æ¯”è¼ƒï¼šå“ªå€‹æœ€å°ï¼Ÿ</label>
          <label class="topic-item"><input type="checkbox" name="topic" value="function-prop" checked> å‡½æ•¸æ€§è³ªï¼šf(k) èˆ‡
            functional
            identities</label>
        </div>

        <div class="font-controls full hidden-after-generate">
          <div class="slider-row">
            <span class="muted">å­—é«”å¤§å°</span>
            <input type="range" id="font-slider" min="12" max="24" value="16">
            <span id="font-val" class="muted">16px</span>
          </div>
          <div class="font-sample" id="font-sample">
            é€™æ˜¯é è¦½æ–‡å­—ï¼š(x + y)Â² = xÂ² + 2xy + yÂ²
          </div>
        </div>
        <input id="count" class="hidden-after-generate" type="number" min="1" max="100" value="10"
          aria-label="é¡Œæ•¸ï¼ˆ1-100ï¼‰" />
        <select id="methodMode" class="hidden-after-generate" aria-label="è§£é¡Œæ¨¡å¼">
          <option value="substitute" selected>è§£é¡Œæ¨¡å¼ï¼šä»£å…¥é¸é …æ³•</option>
          <option value="algebra">è§£é¡Œæ¨¡å¼ï¼šä»£æ•¸æŠ€å·§</option>
        </select>
        <button id="genBtn" class="hidden-after-generate">ç”Ÿæˆé¡Œç›®</button>
        <button id="submitBtn" class="secondary">äº¤å·æ‰¹æ”¹</button>
        <button id="resetBtn" class="secondary">æ¸…é™¤çµæœ</button>
        <button id="backBtn" class="secondary show-after-generate">è¿”å›é–‹å§‹ç‰ˆé¢</button>
        <div class="muted full hidden-after-generate">é¡Œæ•¸ï¼ˆ1-100ï¼‰</div>
      </div>
      <p id="summary" class="summary"></p>
    </section>

    <section id="questions" class="card">
      <p class="muted">è«‹å…ˆæŒ‰ã€Œç”Ÿæˆé¡Œç›®ã€ã€‚</p>
    </section>
  </main>

  <script>
    const $controlCard = document.getElementById('controlCard');
    const $topicGroup = document.getElementById('topicGroup');
    const $count = document.getElementById('count');
    const $methodMode = document.getElementById('methodMode');
    const $genBtn = document.getElementById('genBtn');
    const $submitBtn = document.getElementById('submitBtn');
    const $resetBtn = document.getElementById('resetBtn');
    const $backBtn = document.getElementById('backBtn');
    const $questions = document.getElementById('questions');
    const $summary = document.getElementById('summary');

    let quiz = [];

    function randint(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }
    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function buildFunctionPropertyQuestion(i) {
      // f(x) = ax^2 + bx + c
      const a = pick([1, 1, 1, 2, 2, 3, -1, -2]); // Weighting a=1 more
      // To keep symmetry f(k) = f(2h - k) simple, we want 2h = -b/a to be an integer.
      // So b = -a * S, where S is the sum of roots (or 2 * axis of symmetry)
      const S = pick([-4, -2, 0, 2, 4]); // S = 2h. Correct identity: f(k) = f(S - k)
      const b = -a * S;
      const c = randint(-5, 5);

      function fmtFunc(val, vari, isLead = false) {
        if (val === 0) return "";
        let sign = val > 0 ? (isLead ? "" : " + ") : " - ";
        let absVal = Math.abs(val);
        let coef = absVal === 1 && vari !== "" ? "" : absVal;
        return `${sign}${coef}${vari}`;
      }

      const aText = fmtFunc(a, 'x<sup>2</sup>', true);
      const bText = b === 0 ? "" : fmtFunc(b, 'x', false);
      const cText = c === 0 ? "" : (c > 0 ? ` + ${c}` : ` - ${Math.abs(c)}`);

      const funcDisplay = `f(x) = ${aText}${bText}${cText}`;
      const stem = `è¨­ ${funcDisplay}ã€‚è‹¥ k ç‚ºä¸€å¸¸æ•¸ï¼Œå‰‡ä¸‹åˆ—ä½•è€…å¿…ç‚ºæ­£ç¢ºï¼Ÿ`;

      let rhsIdent;
      if (S === 0) rhsIdent = "f(-k)";
      else rhsIdent = `f(${S} - k)`;

      const options = shuffle([
        { text: `f(k) = ${rhsIdent}`, ok: true },
        { text: `f(k) = ${S === 0 ? '-f(-k)' : `f(${S === 2 ? 1 : S + 2} - k)`}`, ok: false }, // Shifted or sign-flipped
        { text: `f(${S / 2 || 2} + k) = f(${S / 2 || 2}) + f(k)`, ok: false }, // Additive fallacy
        { text: `f(${S / 2 || 2} - k) = f(${S / 2 || 2}) - f(k)`, ok: false }  // Subtractive fallacy
      ]).map((o, idx) => ({ ...o, label: 'ABCD'[idx] }));

      function calcF(x) { return a * x * x + b * x + c; }

      const algebraMethod = `ã€ä»£æ•¸æŠ€å·§ã€‘<br>å·¦å¼ = f(k) = ${a === 1 ? '' : (a === -1 ? '-' : a)}k<sup>2</sup> ${b >= 0 ? '+' : '-'}${Math.abs(b)}k ${c >= 0 ? '+' : '-'}${Math.abs(c)}<br>å³å¼ = ${rhsIdent}ã€‚å°‡å…¶å…¶ä»£å…¥ f(x)ï¼š<br>è‹¥ç‚ºæ­£ç¢ºé¸é …ï¼Œå±•é–‹å¾Œæ‡‰èˆ‡å·¦å¼ç›¸ç­‰ã€‚<br>ä¾‹å¦‚é‡å°æ­£ç¢ºç­”æ¡ˆï¼š<br>f(${S === 0 ? '-k' : `${S}-k`}) = ${a === 1 ? '' : (a === -1 ? '-' : a)}(${S === 0 ? '-k' : `${S}-k`})<sup>2</sup> ${b >= 0 ? '+' : '-'}${Math.abs(b)}(${S === 0 ? '-k' : `${S}-k`}) ${c >= 0 ? '+' : '-'}${Math.abs(c)}<br>å±•é–‹ä¸¦ç°¡åŒ–å¾Œå¿…å¾—èˆ‡å·¦å¼ç›¸åŒçš„é …æ¬¡ã€‚`;

      const kVal = 1;
      const f_k = calcF(kVal);
      const subDetails = options.map(o => `${o.label}: ä»£ k=${kVal}ï¼Œå·¦å¼=f(1)=${f_k}ï¼›æª¢æŸ¥å³å¼å€¼æ˜¯å¦ç›¸ç­‰ã€‚`);

      const substituteMethod = `ã€ä»£å…¥é¸é …æ³•ã€‘<br>æ­¥é©Ÿ 1ï¼šé¸å–ä¸€å€‹é©åˆçš„å¸¸æ•¸å€¼ï¼Œä¾‹å¦‚ä»¤ k = 1ã€‚<br>æ­¥é©Ÿ 2ï¼šæ±‚å‡½æ•¸çš„å€¼ã€‚å·¦å¼ f(k) = f(1) = ${f_k}ã€‚<br>æ­¥é©Ÿ 3ï¼šæ ¹æ“šå››å€‹é¸é …çš„æ¢ä»¶ï¼Œä½œå‡ºæª¢æŸ¥ã€‚<br>${subDetails.join('<br>')}<br>åªæœ‰èˆ‡å·¦å¼å€¼ç›¸åŒçš„é¸é …æ­£ç¢ºã€‚`;

      return { id: i, stem, options, answerLabel: options.find(o => o.ok).label, algebraMethod, substituteMethod, title: 'å‡½æ•¸çš„åŸºæœ¬æ€§è³ª' };
    }

    function buildFactorQuestion(i) {
      const type = pick(['k-sq', 'sq-k', 'sq-sq']);
      let expr, exprPlain, originalVal, algebraMethod, ansText;
      let a, b, c, d, k, p, q, m, n, x, y;

      // Helper to format a factor with randomized term order
      function formatFactor(terms, signs) {
        const zipped = terms.map((t, idx) => ({ t, s: signs[idx] }));
        const shuffled = shuffle(zipped);
        return shuffled.map((item, idx) => {
          let s = item.s === '+' ? (idx === 0 ? '' : ' + ') : (idx === 0 ? '-' : ' - ');
          return `${s}${item.t}`;
        }).join('');
      }

      function getOptionText(A_terms, A_signs, B_terms, B_signs, isCorrect, signFlip = false) {
        // A^2 - B^2 = (A + B)(A - B)
        // Correct answer components:
        // Factor 1: A + B
        // Factor 2: A - B
        let f1_terms = [...A_terms, ...B_terms];
        let f1_signs = [...A_signs, ...B_signs.map(s => s)]; // A + B
        let f2_terms = [...A_terms, ...B_terms];
        let f2_signs = [...A_signs, ...B_signs.map(s => (s === '+' ? '-' : '+'))]; // A - B

        if (!isCorrect) {
          if (signFlip) {
            // Distractor: Flip one sign in B
            const flipIdx = randint(0, B_signs.length - 1);
            f1_signs[A_signs.length + flipIdx] = (f1_signs[A_signs.length + flipIdx] === '+' ? '-' : '+');
          } else {
            // Distractor: (A+B)(A+B) or (A-B)(A-B)
            f2_signs = [...f1_signs];
          }
        }

        let f1 = `(${formatFactor(f1_terms, f1_signs)})`;
        let f2 = `(${formatFactor(f2_terms, f2_signs)})`;
        if (Math.random() > 0.5) [f1, f2] = [f2, f1];
        return `${f1}${f2}`;
      }

      let A_terms, A_signs, B_terms, B_signs;

      if (type === 'k-sq') {
        k = randint(4, 18);
        b = randint(2, 9);
        c = randint(2, 9);
        expr = `${k * k} - (${b}m + ${c}n)<sup>2</sup>`;
        exprPlain = `${k * k} - (${b}m + ${c}n)^2`;
        A_terms = [`${k}`]; A_signs = ['+'];
        B_terms = [`${b}m`, `${c}n`]; B_signs = ['+', '+'];
        originalVal = k * k - (b + c) ** 2; // m=1, n=1
        algebraMethod = `ã€ä»£æ•¸æŠ€å·§ã€‘è¨­ A=${k}ï¼ŒB=${b}m+${c}nã€‚<br>åŸå¼ = A<sup>2</sup>-B<sup>2</sup> = (A+B)(A-B)<br>= (${k}+${b}m+${c}n)(${k}-(${b}m+${c}n))<br>= (${k}+${b}m+${c}n)(${k}-${b}m-${c}n)`;
      } else if (type === 'sq-k') {
        b = randint(2, 9);
        c = randint(2, 9);
        k = randint(4, 18);
        expr = `(${b}x + ${c}y)<sup>2</sup> - ${k * k}`;
        exprPlain = `(${b}x + ${c}y)^2 - ${k * k}`;
        A_terms = [`${b}x`, `${c}y`]; A_signs = ['+', '+'];
        B_terms = [`${k}`]; B_signs = ['+'];
        originalVal = (b + c) ** 2 - k * k; // x=1, y=1
        algebraMethod = `ã€ä»£æ•¸æŠ€å·§ã€‘è¨­ A=${b}x+${c}yï¼ŒB=${k}ã€‚<br>åŸå¼ = A<sup>2</sup>-B<sup>2</sup> = (A+B)(A-B)<br>= (${b}x+${c}y+${k})(${b}x+${c}y-${k})`;
      } else {
        b = randint(2, 6);
        c = randint(2, 6);
        p = randint(2, 6);
        q = randint(2, 6);
        expr = `(${b}m + ${c}n)<sup>2</sup> - (${p}x + ${q}y)<sup>2</sup>`;
        exprPlain = `(${b}m + ${c}n)^2 - (${p}x + ${q}y)^2`;
        A_terms = [`${b}m`, `${c}n`]; A_signs = ['+', '+'];
        B_terms = [`${p}x`, `${q}y`]; B_signs = ['+', '+'];
        originalVal = (b + c) ** 2 - (p + q) ** 2; // m=1, n=1, x=1, y=1
        algebraMethod = `ã€ä»£æ•¸æŠ€å·§ã€‘è¨­ A=${b}m+${c}nï¼ŒB=${p}x+${q}yã€‚<br>åŸå¼ = A<sup>2</sup>-B<sup>2</sup> = (A+B)(A-B)<br>= ((${b}m+${c}n)+(${p}x+${q}y))((${b}m+${c}n)-(${p}x+${q}y))<br>= (${b}m+${c}n+${p}x+${q}y)(${b}m+${c}n-${p}x-${q}y)`;
      }

      function getVal(text) {
        // Simple numeric evaluation for substitution method (m=1, n=1, x=1, y=1)
        // This is a bit complex to parse from string, easier to track mathematically
        return null; // We'll use precalculated values
      }

      const options = shuffle([
        { text: getOptionText(A_terms, A_signs, B_terms, B_signs, true), ok: true },
        { text: getOptionText(A_terms, A_signs, B_terms, B_signs, false, false), ok: false },
        { text: getOptionText(A_terms, A_signs, B_terms, B_signs, false, true), ok: false },
        { text: getOptionText(A_terms, A_signs, B_terms, B_signs, false, true), ok: false }
      ]).map((o, idx) => {
        // For grading and substitution method text, we need the value
        // Since getOptionText is randomized, we'll re-calculate value based on sign logic
        // But for simplicity in this generated exercise, substitution method text will just say "ä»£å…¥æ•¸å€¼"
        return { ...o, label: 'ABCD'[idx], val: isOptionCorrect(type, o.text, originalVal) };
      });

      function isOptionCorrect(type, text, target) {
        // In a real app we'd parse, but here we can just check 'ok' property
        return null;
      }

      const substituteMethod = `ã€ä»£å…¥é¸é …æ³•ã€‘ä»£å…¥è®Šæ•¸çš†ç‚º 1ã€‚<br>åŸå¼ = ${originalVal}ã€‚<br>æª¢æŸ¥å„é¸é …ä»£å…¥å¾Œçš„å€¼ï¼Œåªæœ‰æ­£ç¢ºé¸é …æœƒç­‰æ–¼ ${originalVal}ã€‚`;

      return { id: i, stem: `å› å¼åˆ†è§£ï¼š${expr}`, options, answerLabel: options.find(o => o.ok).label, algebraMethod, substituteMethod, title: 'å¹³æ–¹å·®å› å¼åˆ†è§£' };
    }

    function buildQuadraticKQuestion(i) {
      const p = randint(2, 6);
      const q = pick([1, 4, 9, 16]);
      const s = Math.sqrt(q);
      const r1 = p + s;
      const r2 = p - s;

      const stem = `è¨­ k ç‚ºå¸¸æ•¸ï¼Œè§£æ–¹ç¨‹ï¼š(x - ${p}k)<sup>2</sup> = ${q}k<sup>2</sup>ã€‚`;

      const options = shuffle([
        { text: `x = ${r1}k`, ok: false, roots: [r1] },
        { text: `x = ${r2}k`, ok: false, roots: [r2] },
        { text: `x = ${r1}k æˆ– x = ${r2}k`, ok: true, roots: [r1, r2] },
        { text: `x = -${r1}k æˆ– x = ${r2}k`, ok: false, roots: [-r1, r2] }
      ]).map((o, idx) => ({ ...o, label: 'ABCD'[idx] }));

      const algebraMethod = `ã€ä»£æ•¸æŠ€å·§ã€‘<br>(x-${p}k)<sup>2</sup>=${q}k<sup>2</sup> â‡’ x-${p}k=Â±${s}k<br>æ‰€ä»¥ x=(${p}Â±${s})kï¼Œå³ x=${r1}k æˆ– x=${r2}kã€‚`;
      const subLines = options.map(o => {
        const check = o.roots.map(v => `(x=${v}k): (${v}-${p})Â² ${((v - p) * (v - p) === q) ? '=' : 'â‰ '} ${q}`).join('ï¼› ');
        return `${o.label}: ${check}`;
      });
      const substituteMethod = `ã€ä»£å…¥é¸é …æ³•ã€‘å…ˆä»¤ k=1ï¼Œæ–¹ç¨‹è®Šæˆ (x-${p})<sup>2</sup>=${q}ã€‚<br>${subLines.join('<br>')}<br>åŒæ™‚ç¬¦åˆæ–¹ç¨‹çš„æ ¹çµ„åˆç‚ºæ­£ç¢ºé¸é …ã€‚`;

      return { id: i, stem, options, answerLabel: options.find(o => o.ok).label, algebraMethod, substituteMethod, title: 'äºŒæ¬¡æ–¹ç¨‹èˆ‡åƒæ•¸' };
    }

    function buildPowerScaleQuestion(i) {
      const pack = pick([
        { a: 8, b: 5, base: 10, pa: 3, pb: 1 },
        { a: 4, b: 25, base: 10, pa: 1, pb: 2 },
        { a: 8, b: 125, base: 10, pa: 3, pb: 3 },
        { a: 16, b: 25, base: 10, pa: 4, pb: 2 }
      ]);

      const t = pick([10, 20, 30, 40, 50, 60, 70, 80, 90, 100]);
      const z = randint(1, 6);
      const A = Number((pack.pb * t * z).toFixed(3));
      const B = Number((pack.pa * t * z).toFixed(3));

      const k = Number((pack.pa * A).toFixed(3));
      const stem = `${pack.a}<sup>${A}</sup> Â· ${pack.b}<sup>${B}</sup> =`;

      const options = shuffle([
        { text: `${pack.base}<sup>${k}</sup>`, ok: true, exp: k },
        { text: `${pack.base}<sup>${k + t}</sup>`, ok: false, exp: k + t },
        { text: `${pack.a * pack.b}<sup>${Math.max(1, Math.floor(k / 2))}</sup>`, ok: false, exp: null },
        { text: `${pack.base}<sup>${Math.max(1, k - t)}</sup>`, ok: false, exp: Math.max(1, k - t) }
      ]).map((o, idx) => ({ ...o, label: 'ABCD'[idx] }));

      const scaleCandidates = [10, 100, 1000];
      const strategies = [
        ...scaleCandidates.map(s => ({ op: 'divide', s })),
        ...scaleCandidates.map(s => ({ op: 'multiply', s }))
      ];

      const chosen = strategies
        .map(st => {
          const f = st.op === 'divide' ? (v) => v / st.s : (v) => v * st.s;
          const tScaled = f(k);
          const aScaled = f(A);
          const bScaled = f(B);
          const avg = (aScaled + bScaled + tScaled) / 3;
          const inRangePenalty = (tScaled < 1 || tScaled > 10) ? 100 : 0;
          const score = inRangePenalty + Math.abs(avg - 5.5);
          return { ...st, score, aScaled, bScaled, tScaled };
        })
        .sort((x, y) => x.score - y.score)[0];

      const actionText = chosen.op === 'divide' ? `é™¤ ${chosen.s}` : `ä¹˜ ${chosen.s}`;
      const scaledA = chosen.aScaled;
      const scaledB = chosen.bScaled;
      const targetScaled = chosen.tScaled;
      const transform = (v) => chosen.op === 'divide' ? v / chosen.s : v * chosen.s;

      const compareLines = options.map(o => {
        if (o.exp == null) return `${o.label}: ä¸æ˜¯åŒåº• ${pack.base} çš„æ¨™æº–å½¢å¼ï¼Œå…ˆæ’é™¤ã€‚`;
        return `${o.label}: ${pack.base}<sup>${o.exp}</sup> â†’ ${actionText} å¾Œ ${pack.base}<sup>${transform(o.exp).toFixed(2)}</sup>`;
      });

      const substituteMethod = `ã€æ¬¡æ–¹ç­‰æ¯”ä¾‹ç¸®æ”¾æ³•ã€‘<br>å…ˆåˆ¤æ–·æ¬¡æ–¹å¤§å°ï¼Œå¾ã€Œé™¤/ä¹˜ 10ã€100ã€1000ã€æ€æœ€æ˜“æ¯”è¼ƒæ–¹æ¡ˆï¼›æœ¬é¡Œé¸ã€Œ${actionText}ã€ã€‚<br>æŠŠå…¨éƒ¨æ¬¡æ–¹åŒæ™‚ ${actionText}ï¼ˆæ¯”ä¾‹ä¸è®Šï¼‰ï¼š<br>åŸå¼ ${pack.a}<sup>${A}</sup>Â·${pack.b}<sup>${B}</sup> â†’ ${pack.a}<sup>${scaledA}</sup>Â·${pack.b}<sup>${scaledB}</sup> = ${pack.base}<sup>${targetScaled}</sup>ã€‚<br>å†æŠŠé¸é …æ¬¡æ–¹åšåŒæ¨£è™•ç†ï¼Œæ¯”è¼ƒæœ€å»åˆè€…ã€‚<br>${compareLines.join('<br>')}`;

      const algebraMethod = `ã€ä»£æ•¸æŠ€å·§ã€‘\n${pack.a}=2<sup>${pack.pa}</sup>ï¼Œ${pack.b}=5<sup>${pack.pb}</sup>ã€‚\nåŸå¼ = 2<sup>${pack.pa * A}</sup>Â·5<sup>${pack.pb * B}</sup>ã€‚\nä¾é¡Œç›®æ§‹é€ å¯åˆä½µæˆ (2Â·5)<sup>${k}</sup> = ${pack.base}<sup>${k}</sup>ã€‚`;

      return { id: i, stem, options, answerLabel: options.find(o => o.ok).label, algebraMethod, substituteMethod, title: 'æŒ‡æ•¸é¡Œï¼šæ¬¡æ–¹ç­‰æ¯”ä¾‹ç¸®æ”¾æ³•' };
    }

    function buildLeastCompareQuestion(i) {
      const oddExp = pick([101, 203, 305, 407, 509, 611, 713, 815]);
      const evenExp = oddExp + 1;
      const a = randint(200, 600);
      const b = randint(200, 600);
      const cNum = randint(1, 5);
      const cDen = randint(6, 12);
      const dNum = randint(2, 6);
      const dDen = randint(7, 13);

      const A = `(-${a})<sup>${evenExp}</sup>`;
      const B = `${b}<sup>-${oddExp}</sup>`;
      const C = `(${cNum}/${cDen})<sup>${oddExp}</sup>`;
      const D = `(${dNum}/${dDen})<sup>${evenExp}</sup>`;

      const values = [
        { key: 'A', text: A, value: Math.pow(-a, evenExp) },
        { key: 'B', text: B, value: Math.pow(b, -oddExp) },
        { key: 'C', text: C, value: Math.pow(cNum / cDen, oddExp) },
        { key: 'D', text: D, value: Math.pow(dNum / dDen, evenExp) }
      ];

      const min = values.reduce((m, v) => (v.value < m.value ? v : m), values[0]);
      const options = values.map((v, idx) => ({ label: 'ABCD'[idx], text: v.text, ok: v.key === min.key }));

      const scale = 100;
      const substituteMethod = `ã€æ¬¡æ–¹ç¸®å°æ³•ï¼ˆé™¤ 10 çš„æ¬¡æ–¹ï¼‰ã€‘<br>æœ¬é¡Œç”¨é™¤ 10<sup>2</sup>ï¼ˆå³é™¤ ${scale}ï¼‰ç¸®å°æ¬¡æ–¹æ¯”è¼ƒï¼š<br>- A: (-${a})<sup>${evenExp}</sup> â†’ (-${a})<sup>${(evenExp / scale).toFixed(2)}</sup><br>- B: ${b}<sup>-${oddExp}</sup> â†’ ${b}<sup>${(-oddExp / scale).toFixed(2)}</sup><br>- C: (${cNum}/${cDen})<sup>${oddExp}</sup> â†’ (${cNum}/${cDen})<sup>${(oddExp / scale).toFixed(2)}</sup><br>- D: (${dNum}/${dDen})<sup>${evenExp}</sup> â†’ (${dNum}/${dDen})<sup>${(evenExp / scale).toFixed(2)}</sup><br>ç¸®å°å¾Œæ¯”è¼ƒï¼šè² æ¬¡æ–¹ï¼ˆBï¼‰ä»£è¡¨å€’æ•¸ï¼Œæœ€æ¥è¿‘ 0ï¼Œæ•…æœ€å°æ˜¯ ${min.key}ã€‚`;

      const algebraMethod = `ã€æ¬¡æ–¹ç¸®å°æ³•ï¼ˆé™¤ 10 çš„æ¬¡æ–¹ï¼‰ã€‘<br>æŠŠå„é¸é …æ¬¡æ–¹åŒé™¤ 10<sup>2</sup> å¾Œå†æ¯”è¼ƒï¼š<br>B ä¿æŒè² æ¬¡æ–¹ï¼ˆå€’æ•¸å‹ï¼‰ï¼Œè€Œ A ç‚ºå¤§æ–¼ 1 çš„å¶æ¬¡æ–¹å‹ï¼ŒCã€D ç‚º 0 åˆ° 1 ä¹‹é–“çš„æ­£æ¬¡æ–¹å‹ã€‚<br>æ‰€ä»¥æœ€å°å€¼ç‚º ${min.key}ã€‚`;

      return { id: i, stem: 'ä¸‹åˆ—å“ªä¸€å€‹æœ€å°ï¼Ÿ', options, answerLabel: min.key, algebraMethod, substituteMethod, title: 'æŒ‡æ•¸æ¯”è¼ƒï¼šå“ªå€‹æœ€å°ï¼Ÿ' };
    }

    function buildQuestion(i, topic) {
      if (topic === 'quadratic-k') return buildQuadraticKQuestion(i);
      if (topic === 'power-scale') return buildPowerScaleQuestion(i);
      if (topic === 'least-compare') return buildLeastCompareQuestion(i);
      if (topic === 'function-prop') return buildFunctionPropertyQuestion(i);
      return buildFactorQuestion(i);
    }

    function renderQuiz() {
      if (!quiz.length) {
        $questions.innerHTML = '<p class="muted">è«‹å…ˆæŒ‰ã€Œç”Ÿæˆé¡Œç›®ã€ã€‚</p>';
        return;
      }

      $questions.innerHTML = quiz.map(q => `
          <div class="q" data-id="${q.id}">
            <div class="muted" style="margin-bottom: 5px;">[${q.title}]</div>
            <h3>${q.id}. ${q.stem}</h3>
            ${q.options.map(opt => `
              <label class="opt">
                <input type="radio" name="q-${q.id}" value="${opt.label}">
                <span class="opt-text">${opt.label}. ${opt.text}</span>
              </label>
            `).join('')}
            <div id="result-${q.id}" class="result hide"></div>
          </div>
        `).join('');
    }

    function generate() {
      const selectedTopics = Array.from($topicGroup.querySelectorAll('input[name="topic"]:checked')).map(el => el.value);
      if (selectedTopics.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¡Œå‹');
        return;
      }

      let n = parseInt($count.value, 10);
      if (Number.isNaN(n) || n < 1) n = 1;
      if (n > 100) n = 100;
      $count.value = n;

      quiz = Array.from({ length: n }, (_, idx) => {
        const topic = pick(selectedTopics);
        return buildQuestion(idx + 1, topic);
      });

      const modeText = $methodMode.value === 'algebra' ? 'ä»£æ•¸æŠ€å·§' : 'ä»£å…¥é¸é …æ³•';
      $summary.textContent = `å·²ç”Ÿæˆ ${n} é¡Œï¼Œè§£é¡Œæ¨¡å¼ï¼š${modeText}ã€‚è«‹ä½œç­”å¾ŒæŒ‰ã€Œäº¤å·æ‰¹æ”¹ã€ã€‚`;
      $controlCard.classList.add('collapsed');
      renderQuiz();
    }

    function grade() {
      if (!quiz.length) {
        alert('è«‹å…ˆç”Ÿæˆé¡Œç›®');
        return;
      }

      let answered = 0;
      let correct = 0;

      for (const q of quiz) {
        const checked = document.querySelector(`input[name="q-${q.id}"]:checked`);
        const box = document.getElementById(`result-${q.id}`);
        box.classList.remove('hide', 'ok', 'bad');

        if (!checked) {
          box.classList.add('bad');
          box.innerHTML = `æœªä½œç­”ã€‚æ­£ç¢ºç­”æ¡ˆï¼š${q.answerLabel}`;
          continue;
        }

        answered++;
        if (checked.value === q.answerLabel) {
          correct++;
          box.classList.add('ok');
          box.innerHTML = `âœ… æ­£ç¢ºï¼ˆç­”æ¡ˆï¼š${q.answerLabel}ï¼‰`;
        } else {
          box.classList.add('bad');
          const methodText = $methodMode.value === 'algebra' ? q.algebraMethod : q.substituteMethod;
          box.innerHTML = `âŒ éŒ¯èª¤ï¼Œä½ é¸ ${checked.value}ï¼›æ­£ç¢ºç­”æ¡ˆï¼š${q.answerLabel}<br>${methodText}`;
        }
      }

      const total = quiz.length;
      const wrong = total - correct;
      $summary.textContent = `å®Œæˆæ‰¹æ”¹ï¼š${correct}/${total} æ­£ç¢ºï¼ˆéŒ¯ ${wrong} é¡Œï¼›å·²ä½œç­” ${answered} é¡Œï¼‰ã€‚`;
    }

    function resetResult() {
      for (const q of quiz) {
        const checked = document.querySelector(`input[name="q-${q.id}"]:checked`);
        if (checked) checked.checked = false;
        const box = document.getElementById(`result-${q.id}`);
        if (box) {
          box.className = 'result hide';
          box.textContent = '';
        }
      }
      if (quiz.length) $summary.textContent = `å·²æ¸…é™¤ä½œç­”ï¼Œå¯é‡æ–°ç·´ç¿’ã€‚`;
    }

    function backToStart() {
      $controlCard.classList.remove('collapsed');
      $summary.textContent = 'å·²è¿”å›é–‹å§‹ç‰ˆé¢ï¼Œå¯é‡æ–°é¸æ“‡é¡Œå‹èˆ‡è¨­å®šã€‚';
    }

    // --- Theme & Font Persistence Logic ---
    const themes = ["theme-midnight", "theme-solar", "theme-cyber", "theme-sepia"];
    let currentThemeIdx = 0;

    function applyTheme(idx) {
      document.body.classList.remove(...themes);
      document.body.classList.add(themes[idx]);
      localStorage.setItem("math_theme_idx", idx);
      currentThemeIdx = idx;
    }

    function applyFontSize(size) {
      document.documentElement.style.setProperty('--base-font-size', size + 'px');
      const $slider = document.getElementById('font-slider');
      const $val = document.getElementById('font-val');
      if ($slider) $slider.value = size;
      if ($val) $val.innerText = size + 'px';
      localStorage.setItem("math_font_size", size);
    }

    // Initialize
    const savedTheme = localStorage.getItem("math_theme_idx");
    if (savedTheme !== null) {
      applyTheme(parseInt(savedTheme));
    } else {
      applyTheme(0);
    }

    const savedFont = localStorage.getItem("math_font_size");
    if (savedFont !== null) {
      applyFontSize(parseInt(savedFont));
    }

    document.getElementById('theme-btn').addEventListener('click', () => {
      const nextIdx = (currentThemeIdx + 1) % themes.length;
      applyTheme(nextIdx);
    });

    document.getElementById('font-slider').addEventListener('input', (e) => {
      applyFontSize(e.target.value);
    });

    $genBtn.addEventListener('click', generate);
    $submitBtn.addEventListener('click', grade);
    $resetBtn.addEventListener('click', resetResult);
    $backBtn.addEventListener('click', backToStart);
  </script>
</body>

</html>